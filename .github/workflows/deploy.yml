name: Deploy Demo Discovery Agent

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: SSH and deploy 
              uses: appleboy/ssh-action@v1.0.3
              with:
                host: ${{ secrets.SSH_HOST }}
                username: ${{ secrets.SSH_USERNAME }}
                key: ${{ secrets.SSH_KEY }}
                port: ${{ secrets.SSH_PORT || 22 }}
                timeout: 600s
                command_timeout: 5m
                debug: true
                script: |
                    set -e

                    APP_DIR="/home/nervesparksdev03/all-agents/CMSBlogMaker"
                    BACKEND_DIR="$APP_DIR/backend"

                    echo "=== Pulling latest code ==="
                    cd $APP_DIR
                    git pull origin main

                    echo "=== Updating dependencies === "
                    cd $BACKEND_DIR
                    if [ ! -d "venv" ] || [ ! -f "venv/bin/pip" ]; then
                        echo "=== Creating virtual environment ==="
                        if ! python3 -m venv venv 2>/dev/null; then
                            echo "venv module not available, installing python3-venv..."
                            sudo apt-get update -qq && sudo apt-get install -y python3-venv
                            python3 -m venv venv
                        fi
                    fi
                    venv/bin/pip install -r requirements.txt --upgrade
                    
                    echo "=== Restarting cms-blog-maker-backend ==="
                    # Stop and delete existing process to ensure it uses the venv Python
                    pm2 delete cms-blog-maker-backend 2>/dev/null || true
                    # Start with explicit venv Python interpreter
                    cd $BACKEND_DIR
                    pm2 start main.py --name cms-blog-maker-backend --interpreter ./venv/bin/python
                    pm2 save
                    # Restart the process to ensure it uses the venv Python
                    echo "=== Done ==="
                    pm2 status


